import os
from kodipopcorntime import plugin
from kodipopcorntime.platform import PLATFORM

if PLATFORM["os"] not in ["android", "linux", "windows", "darwin"]:
    plugin.notify(plugin.addon.getLocalizedString(30302) % PLATFORM, delay=15000)
    os._exit(os.EX_SOFTWARE)

from kodipopcorntime.caching import cached_route
from kodipopcorntime.utils import ensure_fanart
from kodipopcorntime.providers import yify
from kodipopcorntime.player import TorrentPlayer
from kodipopcorntime.providers import yify

# Cache TTLs
DEFAULT_TTL = 24 * 3600 # 24 hours

@plugin.route("/")
@ensure_fanart
def index():
    return yify.index()

@plugin.route("/play/<sub>/<uri>")
def play(uri, sub=None):
    if sub == "none":
        sub = None
    TorrentPlayer().init(uri, sub).loop()
    
@plugin.route("/genres")
@ensure_fanart
def genres():
    return yify.genres()

@plugin.route("/genres/<genre>/<page>")
@cached_route(ttl=DEFAULT_TTL, content_type="movies")
@ensure_fanart
def genre(genre, page):
    return yify.genre(genre, page)

@plugin.route("/browse/<sort_by>/<quality>/<page>")
@cached_route(ttl=DEFAULT_TTL, content_type="movies")
@ensure_fanart
def movies(sort_by, quality, page):
    return yify.movies(sort_by, quality, page)

@plugin.route("/search")
def search():
    query = plugin.keyboard("", plugin.addon.getLocalizedString(30001))
    if query:
        yify.search(query)

@plugin.route("/search/<query>/<page>")
@cached_route(ttl=DEFAULT_TTL, content_type="movies")
@ensure_fanart
def search_query(query, page):
    return yify.search_query(query, page)
